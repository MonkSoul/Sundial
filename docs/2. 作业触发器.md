## 2. 作业触发器

`Sundial` 默认内置两种作业触发器，`SimpleTrigger` 和 `CronTrigger`，这两种过滤器无需开发者初始化或自实现，只需要在 `IJob` 实现类贴 `[SimpleJob]` 和 `[CronJob]` 特性即可。

调用 `builder.AddJob<SimpleJob>()` 时会自动读取 `[SimpleJob]` 特性并创建 `SimpleTrigger` 实例。

```cs
[SimpleJob("simple_job", 1000)]
public class SimpleJob : IJob
{
    // ...
}
```

调用 `builder.AddJob<CronJob>()` 时会自动读取 `[CronJob]` 特性并创建 `CronTrigger` 实例。

```cs
[CronJob("cron_job", "* * * * *")]
public class CronJob : IJob
{
    // ...
}
```

### 2.1 自定义作业触发器

如果内置触发器无法满足需求，可自定义作业触发器。如这里获取当前时间，如果秒数是偶数就执行：

2.1.1 添加 `YourTrigger` 并实现 `IJobTrigger` 接口：

```cs
public class YourTrigger : JobTriggerBase, IJobTrigger
{
    public YourTrigger(TimeSpan rates)
    {
        Rates = rates;
    }

    /// <summary>
    /// 调度器检查频率
    /// </summary>
    public TimeSpan Rates { get; }

    /// <summary>
    /// 计算下一次执行时间
    /// </summary>
    public void Increment()
    {
        NumberOfRuns++;
        LastRunTime = NextRunTime;
        NextRunTime = NextRunTime.AddSeconds(2);
    }

    /// <summary>
    /// 触发时机
    /// </summary>
    /// <param name="identity"></param>
    /// <param name="currentTime"></param>
    /// <returns></returns>
    public bool ShouldRun(string identity, DateTime currentTime)
    {
        return NextRunTime < currentTime && LastRunTime != NextRunTime && currentTime.Second % 2 == 0;
    }
}
```

2.1.2 编写 `YourJob`：

```cs
[Job("your_job")]
public class YourJob : IJob
{
    private readonly ILogger<SimpleJob> _logger;
    public YourJob(ILogger<SimpleJob> logger)
    {
        _logger = logger;
    }

    public Task ExecuteAsync(JobExecutingContext context, CancellationToken cancellationToken)
    {
        // // Do your job!!!
        _logger.LogInformation("<{JobName}> {DateTime}", context.JobDetail.Identity, DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
        return Task.CompletedTask;
    }
}
```

2.1.3 注册 `YourJob` 和绑定 `YourTrigger`：

```cs
services.AddSundial(builder =>
{
    builder.AddJob<YourJob>(new YourTrigger(TimeSpan.FromSeconds(1))
    {
        NextRunTime = DateTime.UtcNow
    });
});
```

2.1.4 运行项目

```bash
info: Sundial.JobScheduler[0]
      Scheduler of <your_job> Service is running.
info: Sundial.Samples.SimpleJob[0]
      <your_job> 2021-11-16 17:34:40
info: Sundial.Samples.SimpleJob[0]
      <your_job> 2021-11-16 17:34:42
info: Sundial.Samples.SimpleJob[0]
      <your_job> 2021-11-16 17:34:44
```